sudo: required
dist: trusty
language: ruby

before_install:
- gem install asciidoctor -v 1.5.2
- gem install tilt
- sudo pip install git+https://github.com/gitenberg-dev/gitberg
- sudo pip install git+https://github.com/gitenberg-dev/pg-epubmaker
script:
- VERSION=`ruby -e "require 'yaml'; meta = YAML.load_file('metadata.yaml'); puts meta['_version'];"`
- git clone https://github.com/gitenberg-dev/asciidoctor-htmlbook.git
- sudo pip install -r asciidoctor-htmlbook/gitberg-machine/requirements.txt

- /usr/bin/python -c "from gitenberg import travis; travis.build_epub()"
- ebook-convert book.epub book.mobi
- xvfb-run ebook-convert book.epub book.pdf
notifications:
  webhooks:
    urls:
      - https://unglue.it/api/travisci/webhook
    on_success: always
    on_failure: never
    on_start: never
deploy:
  skip_cleanup: true
  provider: releases
  api_key:
    secure: d6xZZ3N158mZpiRjCtyKBV5bDSzWPEHkLz5f1L1nlKIyaIog0bUC8AJWYqkoJw+I7QxYjEkUMcTSG/Avi5iHNllVrQUtl5Q+eaZtEHdAZYH5ZAhz9F5u4iEaACutcVQYTtmdpqpoWYN5rxYRW8r2Sn5fjmG0hPf+RYzVHgUI/FzovCDKVUWZxTtXMNYQ1vHU7Sojz8+vBx2Tfcif6E7KEKiR0Sj1g+Vojg/pt0muFpTgAncXYP0AE4f9AKwPL4oWzk2+faL2YHY04CaMmZA3MtDAx4Y/6ACW05L613F01MM1HMKGtMZw/Tdu88IRMLTWyb9kd7nGL6buXSg4+fOwg5DE/gLlwUwGqwYc5yjHCrxAI/s2O/Ib3B4SaTy7McNuQZyWQrza0aBuaH79NncpDPJtJ6nSI9sZxyfJ6b0feo7dPxsZvMeE0kElKtk/7YQ6jxCt7yvU2gz1cKzj0Fo2cyyIOg9w7Ihy/yIvIXoRL8pVZLM3C79OaYL8UKgG45jDPa6LJzZ27n1b2XCc5uCGETehIthsg4UGU6XtosVw5fswZYkuZhIzDDRGfZd9n4Yut7xsOeKwuKx0M6uyrlOuMYIn+fpuXzxCkN7rh19dHeMJGtt68HurlhxJmZJKleWldAp7YCPw7mw0aOX7vWOdUQCZvr4gJvP/wL3kWkqk2tU=
  file:
    - book.epub
    - book.mobi
    - book.pdf
  on:
    repo: GITenberg/Before-Adam_310
    tags: true
addons:
  apt:
    packages:
    - xsltproc
    - xvfb
    - calibre
    - python-pip
    - git
    - python-dev
    - libjpeg-dev
    - libpng-dev
    - libfreetype6
    - libfreetype6-dev
    - zlib1g-dev
    - python-lxml
    - libxml2-dev
    - libxslt1-dev
    - tidy